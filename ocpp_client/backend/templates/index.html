<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VESTEL EVC Control Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    /* UI styling */
    body {
      background: linear-gradient(180deg, #0a1f44 0%, #05122d 100%);
      color: #d6e4ff;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    h2 {
      font-weight: 700;
      color: #b3c7ff;
      text-shadow: 0 0 5px #2a4b8d;
    }
    .card {
      background: linear-gradient(135deg, #1f3461 0%, #16264b 100%);
      border-radius: 15px;
      border: 1px solid #294674;
      box-shadow: 0 8px 20px rgba(20, 40, 90, 0.7);
      transition: transform 0.3s ease;
      min-height: 250px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 30px rgba(30, 60, 120, 0.9);
    }
    .card-header {
      font-weight: 700;
      font-size: 1.5rem;
      border-radius: 15px 15px 0 0;
      background: linear-gradient(90deg, #2e4b8f, #3d5cc6);
      color: #e2eaff;
      box-shadow: 0 3px 10px #1e357f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
    }
    .status-badge {
      font-size: 1.1rem;
      padding: 0.5rem 1.2rem;
      border-radius: 40px;
      font-weight: 800;
      color: #ffffff;
      text-shadow: 0 0 5px #4a74e8;
      user-select: none;
      background: linear-gradient(135deg, #4a74e8, #1f3ecc);
      box-shadow: 0 2px 8px rgba(74,116,232,0.9);
    }
    .card-body {
      padding: 1.5rem;
      color: #b0c4ff;
      font-size: 1.1rem;
    }
    .btn-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .btn-group button {
      flex-grow: 1;
      min-width: 110px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 1.05rem;
      padding: 0.5rem 0;
      color: #e2eaff;
      background: linear-gradient(135deg, #3d5cc6, #2e4b8f);
      border: none;
      box-shadow: 0 4px 10px rgba(30, 60, 120, 0.9);
      transition: background-color 0.3s ease;
    }
    .btn-group button:hover {
      background: linear-gradient(135deg, #5a78e8, #4a63d4);
      color: #fff;
      box-shadow: 0 6px 15px rgba(80, 100, 230, 1);
      cursor: pointer;
    }
    .btn-success { background: #4a74e8; }
    .btn-warning { background: #6b84d1; }
    .btn-secondary { background: #3a5083; }
    .btn-danger { background: #2a3a6b; }
    
    /* Connection error overlay styling */
    .connection-error-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #0a1f44 0%, #05122d 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .connection-error-content {
      text-align: center;
      padding: 3rem;
      background: linear-gradient(135deg, #1f3461 0%, #16264b 100%);
      border-radius: 20px;
      border: 2px solid #294674;
      box-shadow: 0 15px 40px rgba(20, 40, 90, 0.9);
      max-width: 600px;
    }
    .connection-error-content h1 {
      color: #ff6b6b;
      margin-bottom: 1.5rem;
      font-size: 2.5rem;
    }
    .connection-error-content p {
      color: #b0c4ff;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .connection-error-content .error-detail {
      color: #ffa94d;
      font-family: monospace;
      background: rgba(0,0,0,0.3);
      padding: 1rem;
      border-radius: 10px;
      margin: 1.5rem 0;
    }
    .retry-button {
      background: linear-gradient(135deg, #4a74e8, #1f3ecc);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 30px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(74, 116, 232, 0.5);
      transition: all 0.3s ease;
    }
    .retry-button:hover {
      background: linear-gradient(135deg, #5a78e8, #4a63d4);
      box-shadow: 0 6px 20px rgba(74, 116, 232, 0.8);
      transform: translateY(-2px);
    }
    .spinner {
      border: 3px solid rgba(74, 116, 232, 0.3);
      border-top: 3px solid #4a74e8;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div id="connectionError" class="connection-error-overlay" style="display: none;">
  <div class="connection-error-content">
    <h1>‚ö†Ô∏è OCPP Baƒülantƒ± Hatasƒ±</h1>
    <p>Client, OCPP Server'a baƒülanamƒ±yor</p>
    <div class="error-detail" id="errorDetail"></div>
    <p id="retryMessage">Otomatik olarak yeniden denenecek<span class="spinner"></span></p>
    <button class="retry-button" onclick="checkConnection()">≈ûimdi Yeniden Dene</button>
  </div>
</div>

<div id="mainContent" class="container py-5">

  <h2 class="mb-5 text-center d-flex align-items-center justify-content-center">
    <img src="/static/vestel_logo.png" 
        alt="VESTEL" 
        style="height: 45px; margin-right: 15px;">
    <span style="color:#adc6ff;">EVC Control Panel</span>
  </h2>
  
  <div id="statusRow" class="row g-4 justify-content-center"></div>
  <div id="errorMessage" class="text-center text-danger" style="display: none;">
    <h3>Unable to connect to the server. Please try again later.</h3>
  </div>
</div>

<script>
const apiBase = "/api";
let connectionCheckInterval = null;
let statusUpdateInterval = null;

const statusBadgeColors = {
  "Available": "bg-primary",
  "Preparing": "bg-warning text-dark",
  "Charging": "bg-info",
  "SuspendedEV": "bg-secondary",
  "SuspendedEVSE": "bg-dark text-light",
  "Finishing": "bg-light text-dark"
};

function getButtonsForStatus(status, connectorId) {
  switch(status) {
    case "Available":
      return `<button class="btn btn-success" onclick="sendCommand(${connectorId}, 'start')">Start</button>`;
    case "Preparing":
      return `<span class="text-muted fst-italic">Preparing...</span>`;
    case "Charging":
      return `
        <button class="btn btn-warning" onclick="sendCommand(${connectorId}, 'suspend')">Suspend</button>
        <button class="btn btn-danger" onclick="sendCommand(${connectorId}, 'stop')">Stop</button>`;
    case "SuspendedEV":
    case "SuspendedEVSE":
      return `
        <button class="btn btn-secondary" onclick="sendCommand(${connectorId}, 'resume')">Resume</button>
        <button class="btn btn-danger" onclick="sendCommand(${connectorId}, 'stop')">Stop</button>`;
    case "Finishing":
      return `<span class="text-muted fst-italic">Finishing...</span>`;
    default:
      return `<button class="btn btn-outline-light" onclick="sendCommand(${connectorId}, 'start')">Start</button>`;
  }
}

async function checkConnection() {
  try {
    const response = await axios.get('/health-check');
    if (response.status === 200) {
      // Baƒülantƒ± ba≈üarƒ±lƒ± - hata ekranƒ±nƒ± gizle, ana i√ßeriƒüi g√∂ster
      document.getElementById('connectionError').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      // Periyodik baƒülantƒ± kontrol√ºn√º durdur
      if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
        connectionCheckInterval = null;
      }
      
      // Status g√ºncellemelerini ba≈ülat
      if (!statusUpdateInterval) {
        fetchStatus();
        statusUpdateInterval = setInterval(fetchStatus, 5000);
      }
      
      return true;
    }
  } catch (error) {
    // Baƒülantƒ± hatasƒ± - hata ekranƒ±nƒ± g√∂ster
    const errorDetail = error.response?.data?.detail || 'Connection failed';
    document.getElementById('errorDetail').textContent = errorDetail;
    document.getElementById('connectionError').style.display = 'flex';
    document.getElementById('mainContent').style.display = 'none';
    
    // Status g√ºncellemelerini durdur
    if (statusUpdateInterval) {
      clearInterval(statusUpdateInterval);
      statusUpdateInterval = null;
    }
    
    // Periyodik kontrol ba≈ülat (eƒüer aktif deƒüilse)
    if (!connectionCheckInterval) {
      connectionCheckInterval = setInterval(checkConnection, 5000);
    }
    
    return false;
  }
}

async function fetchStatus() {
  try {
    // Fetching the server status
    const res = await axios.get(`${apiBase}/status`);
    const data = res.data;

    // Show UI
    const container = document.getElementById("statusRow");
    container.innerHTML = "";

    // Iterate over each connector and display its status
    for (const connectorId in data.connectors) {
      const conn = data.connectors[connectorId];
      const status = conn.status;
      const badgeClass = statusBadgeColors[status] || "bg-secondary";

      const cardHtml = `
        <div class="col-12 col-md-5 col-lg-4">
          <div class="card border-0">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #2e4b8f, #3d5cc6); border-radius: 15px 15px 0 0; color: #e2eaff; font-weight: 700; font-size: 1.5rem; box-shadow: 0 3px 10px #1e357f;">
              <div>üîå Connector ${conn.connector_id}</div>
              <div class="status-badge ${badgeClass}">${status}</div>
            </div>
            <div class="card-body">
              <p><strong>Session Active:</strong> ${conn.session_active}</p>
              <div class="btn-group">
                ${getButtonsForStatus(status, conn.connector_id)}
              </div>
            </div>
          </div>
        </div>
      `;
      container.innerHTML += cardHtml;
    }

    // If data is successfully fetched, hide error message
    document.getElementById("errorMessage").style.display = 'none';
  } catch (error) {
    console.error("Error fetching status:", error);
    // Eƒüer baƒülantƒ± hatasƒ± ise, baƒülantƒ± kontrol√ºne y√∂nlendir
    if (error.response?.status === 503 || error.code === 'ERR_NETWORK') {
      checkConnection();
    } else {
      // Diƒüer hatalar i√ßin mevcut hata mesajƒ±nƒ± g√∂ster
      document.getElementById("statusRow").style.display = 'none';
      document.getElementById("errorMessage").style.display = 'block';
    }
  }
}

async function sendCommand(connectorId, action) {
  try {
    await axios.post(`${apiBase}/connectors/${connectorId}/${action}`);
    await fetchStatus();
  } catch (err) {
    alert("Error: " + (err.response?.data?.detail || err.message));
  }
}

// Sayfa y√ºklendiƒüinde baƒülantƒ±yƒ± kontrol et
document.addEventListener('DOMContentLoaded', function() {
  checkConnection();
});
</script>

</body>
</html>